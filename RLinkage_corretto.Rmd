---
title: "Progetto"
output: html_document
date: "2023-04-14"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}
library(ggplot2)
library(dplyr)
library(epitools)
library(DescTools)
library(survival)
library(survminer)
library(epiR)
```
### Record linkage - prima parte: da 2 a 6

##### 2. Effettuare il record-linkage con lo scopo di costruire l’indicatore ‘Intervento chirurgico di asportazione del tumore al seno entro 60 giorni dalla data di diagnosi’ su base mensile per i casi incidenti nel mese di gennaio 1984.
Denominatore: tutte le pazienti di sesso femminile con tumore al seno insorto tra
01/01/1984 e 31/01/1984, in stadio I o II, che hanno subito un intervento chirurgico
Numeratore: tutte le pazienti al denominatore con intervallo tra la data d’incidenza e la data dell’intervento ≤60 giorni

```{r cars}
#data_deaths =read.csv("dataset/Deathregister.csv", header = TRUE, sep =";")


data_sdo = read.csv("dataset/SDO_clean.csv", header = TRUE, sep =",")

data_cancer = read.csv("dataset/Cancerregister_clean.csv", header=TRUE, sep = ",")

dataMerge=merge(data_cancer, data_sdo, by="idnum")

dataMerge$incidenza = as.Date(dataMerge$incidenza, format = "%Y-%m-%d")
dataMerge$dataprestazione= as.Date(dataMerge$dataprestazione)
dataMerge$dimissione= as.Date(dataMerge$dimissione)

data_gerH = read.csv("dataset/GermanH_clean.csv", header=TRUE, sep = ",")
dataMerge2 = merge(dataMerge, data_gerH, by='idnum')

#pulizia
dataMerge2$Prestazione <- as.factor(dataMerge2$Prestazione)
dataMerge2$ospedale <- as.factor(dataMerge2$ospedale)
dataMerge2$Stadio <- as.factor(dataMerge2$Stadio)
dataMerge2$tipotumore <- as.factor(dataMerge2$tipotumore)
dataMerge2$geneticm <- as.factor(dataMerge2$geneticm)
dataMerge2$smoke <- as.factor(dataMerge2$smoke)
dataMerge2$sex <- as.factor(dataMerge2$sex)
dataMerge2$married <- as.factor(dataMerge2$married)
dataMerge2$kids <- as.factor(dataMerge2$kids)
dataMerge2$work <- as.factor(dataMerge2$work)
dataMerge2$education <- as.factor(dataMerge2$education)

summary(dataMerge2)
```

Per costruire l'indicatore, il denominatore deve soddisfare i seguenti critieri di inclusione:
1. sex: female
2. tipotumore: seno
3. Stadio: Stadio II, Stadio III
4. intervallo di tempo fra diagnosi e intervento = 60 giorni
5. incidenza: dal 1984-01-01 al 1984-01-31
6. prestazione: chirurgica

Al numeratore invece, verranno incluse solamente le pazienti che hanno subito un intervento entro 60 giorni dalla data d'incidenza. Verrà quindi creata una nuova variabile binaria per indicare la presenza dell'evento o meno.

```{r}
#denominatore
data = dataMerge2[dataMerge2$sex == 'Female',]
data = data[data$Stadio == 'Stadio II' | data$Stadio == 'Stadio III',]
data = data[data$tipotumore=='seno', ]
data = data[data$Prestazione=='chirurgica',]
summary(data)
dim(data)
```

La variabile 'incidenza' soddisfa già i criteri di inclusione. Come possiamo notare dalle statistiche descrittive, la data è compresa tra l'11/01/1984 e il 20/01/1984.

Al numeratore verranno incluse tutte le pazienti del denominatore che hanno subito l'intervento entro 60 giorni. 

Attraverso il seguente codice, si aggiunge la variabile "intervallo" per calcolare il numero di giorni fra la data di prestazione e la data di incidenza.

```{r}
data$intervallo = as.numeric(data$dataprestazione - data$incidenza)
summary(data$intervallo)
```
Osservando la nuova variabile 'intervallo' possiamo notare che il tempo minimo di attesa per la prestazione è pari a 9 giorni, invece il tempo massimo di attesa equivale a 193 giorni.

In seguito, viene creata la variabile binaria 'intervento60gg' per individuare le osservazioni che hanno subito o meno l'intervento entro 60 giorni.


```{r}
data$intervento60gg = ifelse(data$intervallo <= 60, 1, 0)
T1 = table(data$intervento60gg); T1 #indicatore tumore seno
prop.table(T1)
indicatore = T1[2]/(T1[2]+T1[1]) #
indicatore
```
 L'indicatore è pari a 0.63. La percentuale di interventi entro 60 giorni dalla data di diagnosi è pari al 63%. 
 
##### 3. Calcolare l’indicatore ‘Intervento chirurgico di asportazione del tumore al seno entro 60 giorni dalla data di diagnosi’ per ospedale e darne rappresentazione grafica, includendo come valore di riferimento nel grafico l’indicatore calcolato sull’intero dataset. Per esempi relativi alla rappresentazione grafica fare riferimento al sito Piano Nazionale Esiti (PNE) o siti analoghi trattati a lezione.


```{r}
table(data$ospedale)
#indicatore grezzo
TT<-table(evento = data$intervento60gg, ospedale = data$ospedale);TT 
prop.table(TT,2) #indicatore seconda posizione evento 1


data$intervento60gg = as.factor(data$intervento60gg)
#indicatore grezzo
ggplot(data, aes(x = ospedale, fill = intervento60gg)) +
  geom_bar(position = "fill") +
  theme_classic() 
```

Come si evince dal grafico sovrastante, gli ospedali 7 e 8 sono quelli con percentuale maggiore relativa alle osservazioni che hanno subito l'evento, rispettivamente pari a 70% e 73%. L'ospedale 1, invece, presenta la percentuale minore di osservazioni che hanno subito l'evento, pari a 53%.

Nella tabella seguente vengono riportati gli indicatori per ospedale.

```{r}
indice <- data %>%
  group_by(ospedale)%>%
  summarise(indice=sum(intervento60gg == 1)/n())
indice
```

```{r}
bar_plot = ggplot(indice, aes(x = reorder(ospedale, indice), y = indice)) +
  geom_bar(stat = "identity", fill = "darkgreen") +
  xlab("Ospedale") +
  ylab("Indicatore") +
  ggtitle("Indicatore per ospedale") +
  theme(plot.title = element_text(size = 14, hjust = 0.5),
        axis.text.x = element_text(angle = 0, vjust = 0, hjust=0.5)) +
  geom_hline(yintercept = indicatore, linetype='dashed', color='black')
  
bar_plot
```

 
Considerando il valore dell'indicatore di riferimento, calcolato in precedenza sull’intero dataset, pari a 0.63, gli ospedali 3, 4, 5, 7, 8 presentano un valore superiore. Invece, gli ospedali 1, 9, 2, 6 presentano un valore inferiore.

##### 4. Utilizzare il dataset ottenuto per valutare l’associazione a livello individuale tra il livello di educazione ed il valore dell’indicatore ‘Intervento chirurgico di asportazione del tumore al seno entro 60 giorni dalla data di diagnosi’. Quale misura di effetto è possibile stimare? Calcolate ed interpretate tale misura di effetto grezza. Riportare anche la relativa tabella di contingenza.


Per valutare l'associazione tra il livello di educazione e l'intervento chirurgico di asportazione del tumore al seno entro 60 giorni dalla diagnosi, è possibile utilizzare una tabella di contingenza dove vengono riportati i valori che indicano il numero di casi che rientrano in ogni combinazione di categoria di educazione e di intervento chirurgico.


```{r}
tabella_contingenza <- table(data$education, data$intervento60gg)
tabella_contingenza
OR <- (tabella_contingenza[1,1]/tabella_contingenza[1,2])/(tabella_contingenza[2,1]/tabella_contingenza[2,2])
OR
```
La misura di effetto che è possibile stimare in questo caso è l'odds ratio, esso ci permette di confrontare le probabilità di un evento tra due gruppi. In particolare, in questo caso si vuole confrontare la probabilità che una donna con un basso livello di educazione abbia un intervento chirurgico di asportazione del tumore al seno entro 60 giorni dalla diagnosi con la probabilità che una donna con un medio/alto livello di educazione abbia lo stesso intervento entro lo stesso periodo.

```{r}
epitab(data$education, data$intervento60gg, method = c("oddsratio")) 
```
Come si evince dal risultato sovrastante, l'odds ratio è pari a 1.05 con un intervallo di confidenza (0.52, 2.13); poiché l'intervallo di confidenza include il valore 1, non è possibile concludere che l'odds ratio sia significativamente diverso da 1.

L'odds ratio può essere calcolato anche attraverso un modello logistico:
```{r}
modello_logistico_seno <- glm(intervento60gg ~ education, family = binomial(), data = data)
# Riepilogo del modello
summary(modello_logistico_seno)
#Lettura Coefficienti
exp(cbind("OR" = coef(modello_logistico_seno), confint.default(modello_logistico_seno, level = 0.95)))
```

I risultati coincidono nei tre metodi utilizzati.

##### 5. Calcolate la stessa misura di effetto, questa volta aggiustata per la sola variabile ‘working’, mediante il metodo Mantel Haenszel. Interpretate il risultato.


Per calcolare l'OR tramite il metodo Mantel Haenszel viene costruita una tabella di contingenza per i due gruppi in base allo stato lavorativo. 

```{r}
tabella_contingenza_1 <- table(education = data$education, evento = data$intervento60gg, work = data$work)
tabella_contingenza_1
```

Per verificare la possibilità di utilizzare l'OR di Mantel Haenszel viene utilizzato il test di Breslow-Day, il quale testa l'omogeneità degli odds ratio nei due gruppi.

```{r}
BreslowDayTest(tabella_contingenza_1)
```
 
Il test non rifiuta l'ipotesi nulla di omogeneità; si può proseguire nel calcolo dell'OR.

```{r}
OR_adj <- mantelhaen.test(tabella_contingenza_1, conf.level = 0.95)
OR_adj
```
L'OR di Mantel Haenszel non è significativamente diverso da 1, controllando per la variabile 'working'. Inoltre, il rapporto fra l' odds ratio crudo e quello di mantel haenszel è pari a circa 1.00. Questo significa che lo stato lavorativo non è un confondente nell'associazione tra il livello di educazione e l'intervento chirurgico di asportazione del tumore al seno entro 60 giorni dalla data di diagnosi.

##### 6. Stimate l’associazione a livello individuale tra il livello di educazione ed il valore dell’indicatore, aggiustata per tutte le variabili disponibili che ritenete opportuno inserire come potenziali confondenti, mediante un modello di regressione logistica. Interpretate i risultati. Su quanti soggetti avete effettuato l’analisi? Quali variabili sono associate all’indicatore? In che modo?

```{r}
#analisi di regressione logistica

modello <- glm(intervento60gg ~ education, data = data, family = binomial())
exp(cbind("OR" = coef(modello), confint.default(modello, level = 0.95)))

#geneticm
modello_gen<- glm(intervento60gg ~ education + geneticm, data = data, family = binomial())
exp(cbind("OR" = coef(modello_gen), confint.default(modello_gen, level = 0.95)))
ratio_gen = exp(coef(modello)['educationmedium/high'])/exp(coef(modello_gen)['educationmedium/high'])
ratio_gen
```

Una delle variabili che si é ritenuto considerare come confondente è "geneticm". Ciò nonostante, il rapporto fra l'OR crudo e quello di MH è pari a circa 1.00. Ciò significa che non è un confondente.

```{r}
#smoke
modello_stadio <- glm(intervento60gg ~ education + Stadio , data = data, family = binomial())
exp(cbind("OR" = coef(modello_stadio), confint.default(modello_stadio, level = 0.95)))
ratio_stadio = exp(coef(modello)['educationmedium/high'])/exp(coef(modello_stadio)['educationmedium/high'])
ratio_stadio
```

Un'altra variabile presa in considerazione come possibile confondente è "Stadio". Si osserva che, anche in questo caso, il rapporto tra fra l'OR crudo e quello di MH è pari a circa 0.98. Ciò significa che la variabile non è un confondente.


Infine,  si va a controllare per la variabile 'age' suddivisa in 5 intervalli. 

```{r}
#age
classe_1 <- 28
classe_2 <- 42
classe_3 <- 56
classe_4 <- 70
classe_5 <- 84
classe_6 <- 98
data$age_class <- as.factor(cut(data$age, breaks = c(classe_1, classe_2, classe_3, classe_4, classe_5, classe_6), labels = FALSE))
modello_age <- glm(intervento60gg ~ education + age_class, data = data, family = binomial())
exp(cbind("OR" = coef(modello_age), confint.default(modello_age, level = 0.95)))
ratio_age = exp(coef(modello)['educationmedium/high'])/exp(coef(modello_age)['educationmedium/high'])
ratio_age
```

Anche in questo caso, la variabile scelta, 'age', non è un confondente.

L'analisi è stata eseguita su tutte le persone del dataset.

```{r}
dim(data)
```

Le persone del dataset sono 291.

### Record linkage - seconda parte: dal punto 7 in poi
##### Considerate ora tutti i tumori al colon insorti nel gennaio 1984. Unire i data-set utili per studiare la mortalità del tumore al colon nei soggetti inclusi nell’estrazione del German health Register (dataset 1).

```{r}
data_death = read.csv("dataset/Deathregister.csv", header = TRUE, sep =";")
data_cancer = read.csv("dataset/Cancerregister_clean.csv", header=TRUE, sep = ",")
dataMerge3 = merge(data_cancer, data_death, by="idnum")

data_gerH = read.csv("dataset/GermanH_clean.csv", header=TRUE, sep = ",")
dataMerge4 = merge(dataMerge3, data_gerH, by='idnum')

## Pulizia
dataMerge4$incidenza <- as.Date(dataMerge4$incidenza, format = "%Y-%m-%d")
dataMerge4$enddate <- as.Date(dataMerge4$enddate, format = "%Y-%m-%d")
dataMerge4$Stadio <- as.factor(dataMerge4$Stadio)
dataMerge4$tipotumore <- as.factor(dataMerge4$tipotumore)
dataMerge4$geneticm <- as.factor(dataMerge4$geneticm)
dataMerge4$smoke <- as.factor(dataMerge4$smoke)
dataMerge4$sex <- as.factor(dataMerge4$sex)
dataMerge4$married <- as.factor(dataMerge4$married)
dataMerge4$kids <- as.factor(dataMerge4$kids)
dataMerge4$work <- as.factor(dataMerge4$work)
dataMerge4$education <- as.factor(dataMerge4$education)
dataMerge4$dead <- as.factor(dataMerge4$dead)

summary(dataMerge4)
```

##### 7. Selezionate i record relativi ai tumori al colon e stimate la sopravvivenza a 5 anni. Quanti soggetti sono inclusi nell’analisi? Quanti pazienti sono morti nel periodo di interesse? Riportare graficamente la stima di sopravvivenza nei primi 5 anni dalla diagnosi stimata tramite lo stimatore di Kaplan-Meier. Stimare approssimativamente la sopravvivenza mediana.

```{r}
colon <- dataMerge4[dataMerge4$tipotumore=="colon",]
length(colon[colon$incidenza>colon$enddate])
```

```{r}
dim(colon)
```

Nell'analisi sono inclusi 1304 soggetti.

```{r}
table(colon$dead)
```

Nel periodo di interesse sono morti 707 pazienti.

Si stima la sopravvivenza di Kaplan-Meier, che viene rappresentata graficamente.

```{r}
colon$survtime <- as.numeric(colon$enddate-colon$incidenza)/365.25

fit<-survfit(Surv(survtime, as.numeric(dead)) ~1,data=colon)
summary(fit)

ggsurvplot(fit, data = colon, risk.table = TRUE, conf.int = TRUE, conf.int.fill = "black", conf.int.style = "step", surv.median.line = "h", censor.size=2.5, risk.table.fontsize = 3.5, censor.shape=".", xlab="Time (years)")
```

Nel grafico è riportata la sopravvivenza nei primi 5 anni calcolata con lo stimatore di Kaplan-Meier.

La sopravvivenza mediana, come si osserva nel grafico, è poco inferiore a 4 anni.

##### 8. Stimare la sopravvivenza nei primi 5 anni dalla diagnosi per Stadio e effettuare un test d’ipotesi per verificare se l’azzardo di morte sia diverso per stadio di malattia alla diagnosi.

Si stima la sopravvivenza di Kaplan-Meier per stadio, che viene rappresentata graficamente.

```{r}
fit<-survfit(Surv(survtime, as.numeric(dead)) ~ Stadio,data=colon)
summary(fit)

ggsurvplot(fit, data = colon, risk.table = TRUE, conf.int = TRUE, surv.median.line = "h", pval = TRUE, censor.size=2.5, risk.table.fontsize = 3, risk.table.height = 0.35, censor.shape="|", xlab="Time (years)", legend = "right")
```

Dal grafico della sopravvivenza di Kaplan-Meier risulta piuttosto evidente una differenza sul trend della sopravvivenza per stadio.

Si esegue un test di ipotesi log-rank per valutare se la differenza è significativa.

```{r}
survdiff(Surv(survtime,as.numeric(dead)) ~ Stadio,data=colon)
```

Il test ha un p-value inferiore a 2e-16, dunque si rigetta l'ipotesi nulla: la differenza tra gli azzardi è statisticamente significativa.

##### 9. Applicare un modello per valutare l’associazione tra sesso e mortalità e interpretare la misura di effetto stimata.

Si applica un modello di regressione logistica per valutare l'associazione.

```{r}
modello <- glm(dead ~ relevel(sex, "Male"), data = colon, family = binomial())
summary(modello)
exp(cbind("OR" = coef(modello), confint.default(modello, level = 0.95)))
```

La misura di effetto ricavata dal modello è l'ODDS Ratio, pari a 1.53. Ciò significa che gli uomini hanno un valore di ODDS di morte superiore del 50% rispetto alle donne.

##### 10. Quali variabili sono associate alla mortalità? Riportare le relative stime di effetto con gli intervalli di confidenza.

Per studiare l'associazione tra variabili e mortalità si applica un modello di regressione logistica usando come covariate tutte le variabili del dataset.

```{r}
modello10 <- glm(dead ~ sex + Stadio + geneticm + smoke + married + kids + work + education + age, data = colon, family = binomial())
summary(modello10)
exp(cbind("OR" = coef(modello10), confint.default(modello10, level = 0.95)))
```

Le variabili che hanno una associazione significativa con la mortalità, e quindi un OR significativamente diverso da 1, sono tutte quelle testate ad eccezione di "married", "kids" e "work".

##### 11. Valutare la presenza di confondenti e/o modificatori di effetto tra le variabili disponibili nel German health register e nel registro tumori nella valutazione dell’associazione tra sesso e mortalità. Se identificate un’interazione tra sesso e un’altra variabile riportare le stime di effetto per maschi e femmine separatamente e commentare il tipo di interazione trovato.

Si studia la correlazione tra morti e sesso, valutando la presenza di confondenti o modificatori tramite stratificazione.

La prima variabile studiata come eventuale confondente o modificatore di effetto è il fattore genetico.

```{r}
cont_table_geneticm <- table(sex = colon$sex,
                             dead = relevel(colon$dead, "1"),
                             genetic = colon$geneticm)
strat_geneticm<-epi.2by2(dat=cont_table_geneticm , method="cohort.count")
strat_geneticm$massoc.detail$RR.strata.wald
strat_geneticm$massoc.detail$OR.strata.wald
```

Si osserva una differenza sia tra gli ODDS Ratio che tra i Rischi Relativi. Si verifica se la differenza è significativa tramite il test di omogeneità.

```{r}
strat_geneticm$massoc.detail$wRR.homog
strat_geneticm$massoc.detail$wOR.homog
```

Il test di omogeneità risulta significativo per i Rischi Relativi: il fattore genetico è un modificatore d'effetto per questa misura. Il test di omogeneità sugli OR risulta non significativo.

```{r}
strat_geneticm
```

Il rapporto tra l'OR crudo e l'OR di MH è pari a 1: il fattore genetico non è un confondente per l'OR.

Si valutano i RR separatamente per sesso.

```{r}
cont_table_geneticm_male <- table(genetic = relevel(colon$geneticm, "1")[colon$sex=="Male"],
                                  dead = relevel(colon$dead, "1")[colon$sex=="Male"])
strat_geneticm_male<-epi.2by2(dat=cont_table_geneticm_male, method="cohort.count")
strat_geneticm_male

cont_table_geneticm_female <- table(genetic = relevel(colon$geneticm, "1")[colon$sex=="Female"],
                                    dead = relevel(colon$dead, "1")[colon$sex=="Female"])
strat_geneticm_female<-epi.2by2(dat=cont_table_geneticm_female, method="cohort.count")
strat_geneticm_female
```

L'effetto del fattore genetico negli uomini è maggiore rispetto alle donne: se si considerano gli uomini come classe di riferimento, l'interazione è negativa.

Si studia ora la variabile "smoke".

```{r}
cont_table_smoke <- table(sex = colon$sex,
                          dead = relevel(colon$dead, "1"),
                          smoke = colon$smoke)
strat_smoke<-epi.2by2(dat=cont_table_smoke , method="cohort.count")
strat_smoke$massoc.detail$RR.strata.wald
strat_smoke$massoc.detail$OR.strata.wald
```

In questo caso entrambe le misure di effetto sono molto simili in entrambi gli strati. Ci si aspetta che i test non siano significativi.

```{r}
strat_smoke$massoc.detail$wRR.homog
strat_smoke$massoc.detail$wOR.homog
```

In entrambi i casi i test non sono significativi: la variabile non è un modificatore di effetto ed è possibile calcolare una misura di effetto comune tramite il metodo di Mantel Haenszel.

```{r}
strat_smoke
```

Dal rapporto tra l'OR crudo e quello di MH, si evince che la variabile "smoke" non è un confondente per questa misura di effetto. Analogamente accade per il RR. 

Si procede ora alla valutazione della variabile "married".

```{r}
cont_table_married <- table(sex = colon$sex,
                            dead = relevel(colon$dead, "1"),
                            married = colon$married)
strat_married<-epi.2by2(dat=cont_table_married , method="cohort.count")
strat_married$massoc.detail$RR.strata.wald
strat_married$massoc.detail$OR.strata.wald
strat_married$massoc.detail$wRR.homog
strat_married$massoc.detail$wOR.homog
strat_married
```

Si osserva che la variabile non è un confondente né un modificatore di effetto per nessuna delle due misure di effetto calcolate.

Si procede ora alla valutazione della variabile "kids".

```{r}
cont_table_kids <- table(sex = colon$sex,
                         dead = relevel(colon$dead, "1"),
                         kids = colon$kids)
strat_kids<-epi.2by2(dat=cont_table_kids , method="cohort.count")
strat_kids$massoc.detail$RR.strata.wald
strat_kids$massoc.detail$OR.strata.wald
strat_kids$massoc.detail$wRR.homog
strat_kids$massoc.detail$wOR.homog
strat_kids
```

La variabile non è né confondente né modificatore di effetto.

Si procede ora alla valutazione della variabile "work".

```{r}
cont_table_work <- table(sex = colon$sex,
                         dead = relevel(colon$dead, "1"),
                         work = colon$work)
strat_work<-epi.2by2(dat=cont_table_work , method="cohort.count")
strat_work$massoc.detail$RR.strata.wald
strat_work$massoc.detail$OR.strata.wald
strat_work$massoc.detail$wRR.homog
strat_work$massoc.detail$wOR.homog
strat_work
```

La variabile non è né confondente né modificatore di effetto.

Si procede ora alla valutazione della variabile "education".

```{r}
cont_table_education <- table(sex = colon$sex,
                              dead = relevel(colon$dead, "1"),
                              education = colon$education)
strat_education<-epi.2by2(dat=cont_table_education , method="cohort.count")
strat_education$massoc.detail$RR.strata.wald
strat_education$massoc.detail$OR.strata.wald
strat_education$massoc.detail$wRR.homog
strat_education$massoc.detail$wOR.homog
```

Il test sull'omogeneità dei Rischi Relativi è significativo: la variabile è un modificatore di effetto per il RR.

```{r}
strat_education
```

"education" non è un confondente per l'OR.

Si procede a stimare il RR per maschi e femmine separatamente.

```{r}
cont_table_education_male <- table(education = relevel(colon$education, "medium/high")[colon$sex=="Male"],
                                   dead = relevel(colon$dead, "1")[colon$sex=="Male"])
strat_education_male<-epi.2by2(dat=cont_table_education_male, method="cohort.count")
strat_education_male

cont_table_education_female <- table(education = relevel(colon$education, "medium/high")[colon$sex=="Female"],
                                     dead = relevel(colon$dead, "1")[colon$sex=="Female"])
strat_education_female<-epi.2by2(dat=cont_table_education_female, method="cohort.count")
strat_education_female
```

L'effetto dell'educazione negli uomini è maggiore rispetto alle donne: se si considerano gli uomini come classe di riferimento, l'interazione è negativa.

Si procede ora alla valutazione della variabile "Stadio".

```{r}
cont_table_stadio <- table(sex = colon$sex,
                    dead = relevel(colon$dead, "1"),
                    stadio = colon$Stadio)
strat_stadio<-epi.2by2(dat=cont_table_stadio , method="cohort.count")
strat_stadio$massoc.detail$RR.strata.wald
strat_stadio$massoc.detail$OR.strata.wald
strat_stadio$massoc.detail$wRR.homog
strat_stadio$massoc.detail$wOR.homog
strat_stadio
```

I test di omogeneità risultano significativi per entrambe le misure di effetto. Si procede al calcolo del valore dell'effetto separatamente per maschi e femmine.

```{r}
model_bin_male <- glm(dead ~ Stadio, data=colon[colon$sex=="Male",], family="binomial")
summary(model_bin_male)
exp(cbind("Odds ratio" = coef(model_bin_male), confint.default(model_bin_male, level = 0.95)))

model_bin_female <- glm(dead ~ Stadio, data=colon[colon$sex=="Female",], family="binomial")
summary(model_bin_female)
exp(cbind("Odds ratio" = coef(model_bin_female), confint.default(model_bin_female, level = 0.95)))
```

Gli uomini hanno un OR minore tra Stadio 1 e 2 e tra Stadio 1 e 3 rispetto alle donne. Hanno invece un OR maggiore tra Stadio 1 e 4 rispetto alle donne.

Si procede alla stima dei RR.

```{r}
model_pois_male <- glm(I(as.numeric(dead)-1) ~ Stadio, data = colon[colon$sex=="Male",], family = poisson)
exp(cbind("Relative risk" = coef(model_pois_male), confint.default(model_pois_male, level = 0.95)))

model_pois_female <- glm(I(as.numeric(dead)-1) ~ Stadio, data = colon[colon$sex=="Female",], family = poisson)
exp(cbind("Relative risk" = coef(model_pois_female), confint.default(model_pois_female, level = 0.95)))
```

Gli uomini hanno in tutti i casi un RR minore rispetto alle donne: prendendo come riferimento il livello "Male", si ha dunque una interazione negativa.

Si procede ora alla valutazione della variabile "age".

```{r}
model <- glm(dead ~ relevel(sex, "Male") + age, data=colon, family="binomial")
summary(model)
model2 <- glm(dead ~ relevel(sex, "Male") * age, data=colon, family="binomial")
summary(model2)
anova(model,model2,test="LRT")
```

Si osserva che l'interazione non è significativa, secondo il test LRT: age non è un modificatore di effetto.

```{r}
model3 <- glm(dead ~ relevel(sex, "Male"), data=colon, family="binomial")
or_crude <- exp(cbind("Crude Odds ratio" = coef(model3), confint.default(model3, level = 0.95)))
or_mh <- exp(cbind("MH Odds ratio" = coef(model), confint.default(model, level = 0.95)))
ratio <- or_crude[2]/or_mh[2]
ratio
```

Il rapporto tra i due OR è pari a 1.08. Tenendo come valore limite per il confondimento uno scostamento del 10%, è possibile affermare che non c'è confondimento da parte della variabile "age".

Risultano quindi modificatori di effetto le variabili "geneticm", "education" e "Stadio".

##### 12. A seguito delle considerazioni effettuate nei punti precedenti scegliete un modello finale per valutare i fattori di rischio della mortalità dopo diagnosi di tumore al colon e commentate i risultati.

Poiché lo studio è uno studio di mortalità, si utilizza il modello di Cox per tenere conto anche dei diversi tempi di mortalità. Come covariate si scelgono le variabili risultate significative nel punto 10. La variabile sex è aggiustata per i confondenti osservati al punto 11.

```{r}
model_cox <- coxph(Surv(survtime, I(as.numeric(dead)-1)) ~ relevel(sex, "Male") + geneticm + education + Stadio + smoke + age, data=colon)
summary(model_cox)
```

Il modello di Cox assume che l'Hazard Ratio rimanga costante nel tempo. Si verifica graficamente questo assunto, iniziando dalla variabile sex.

```{r}
stima <- survfit(Surv(survtime, I(as.numeric(dead)-1)) ~ relevel(sex, "Male"), data=colon)

check <- log(-log(stima[sex=1]$surv))
plot(stima[sex=1]$time, check, type='l', xlab='time', ylab='log(-log(S(t)))', col="blue")
points(stima[sex=1]$time, check, pch=".", cex=3, col="blue")

check <- log(-log(stima[sex=2]$surv))
lines(stima[sex=2]$time, check, type='l', col="red")
points(stima[sex=2]$time, check, pch=".", cex=3, col="red")

legend(x=3.5, y=-4.5, col=c("blue", "red"), legend=c("Male", "Female"), lwd=1)
```

Palesemente la distanza non è costante. Da capire cosa fare.
