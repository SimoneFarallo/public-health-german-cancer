---
title: "Exploration & Cleaning"
author: "Simone Farallo"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

Il presente progetto si propone di esaminare quattro dataset relativi alla situazione sanitaria di una piccola cittadina tedesca nel periodo compreso tra il 1984 e il 1988, i dataset che andremo ad analizzare sono:

1.estratto del **German health registry** per l’anno 1984 relativo ad una piccola cittadina
(dataset reale openData modificato). Le variabili che lo compongono sono le
seguenti (e sono relative alla situazione del cittadino all’inizio del 1984):
-idnum: codice identificativo del soggetto
-smoke (yes or no): se il soggetto fuma
-sex (Female or Male)
-married (yes or no): se è coniugato
-kids (yes or no): se il soggetto ha figli
-work (yes or no): se lavora
-education ( no/low = da nessuna a diploma scuola media inferiore;medium/high = diploma scuola media superiore o oltre)
-age (numerica, in anni)

2. **Registro tumori tedesco**(dataset simulato) relativo al mese di Gennaio
1984. Le variabili che lo compongono sono le seguenti:
- idnum: codice identificativo del paziente
- stadio (I, II, III, IV): stadio del tumore alla diagnosi
- incidenza: data di diagnosi del tumore
-tipo di tumore: seno, polmone, colon, altro
-geneticm: fattore genetico (1=positivo, 0=negativo)

3. **Schede di dimissione ospedaliera** dei soggetti ricoverati in Germania tra gennaio 1984 e
ottobre 1984 per trattamenti oncologici (dataset simulato):
-idnum: codice identificativo del soggetto
- Prestazione: tipo di trattamento ricevuto durante il ricovero (chirurgica, chemioterapica o radioterapica)
- data prestazione: data del trattamento
- dimissione: data di dimissione dall’ospedale
- ospedale: codice univoco dell’ospedale

4. Estratto del **Registro di mortalità** della cittadina tedesca che riporta la mortalità dal 1984 al
1988 e lo stato in vita alla fine del 1988(dataset simulato):
-idnum: codice identificativo del cittadino
-dead: stato in vita alla data enddate
-enddate: data di ultima osservazione (se dead=1 data di morte)

In questa prima fase  l'obiettivo è quello di riportare le statistiche descrittive in una tabella per ciascun dataset, con particolare attenzione alla presenza di dati mancanti, incongruenze tra date e record ripetuti che potrebbero creare problemi in fase di linkage e analisi. Saranno segnalati nel report i record con dati ripetuti o incongruenze tra date e saranno eliminati per le analisi successive.


#Preliminary operation

Installazione e caricamento dei pacchetti
```{r}
#install.packages("ggpubr", dependencies=TRUE)
```

```{r}
library(ggplot2)
library(ggpubr)
```


# Loading datasets .

```{r}
cancer<-read.csv("https://raw.githubusercontent.com/SimoneFarallo/public_helth_simo/main/Cancerregister.csv", header = TRUE, sep =";")
death<-read.csv("https://github.com/SimoneFarallo/public_helth_simo/raw/main/Deathregister.csv", header = TRUE, sep =";")
GermanH<-read.csv("https://github.com/SimoneFarallo/public_helth_simo/raw/main/GermanH.csv", header = TRUE, sep =";")
sdo<-read.csv("https://github.com/SimoneFarallo/public_helth_simo/raw/main/SDO.csv", header = TRUE, sep =";")
```


```{r}
View(cancer)
View(death)
View(GermanH)
View(sdo)
```

# Cleaning & Exploration

## Cancer

Controllo dei duplicati
```{r}
cancer$idnum[duplicated(cancer$idnum)]
cancer[cancer$idnum== 192,]
cancer[cancer$idnum== 363,]
cancer[cancer$idnum== 1933,]
```
Eliminazione dei duplicati
```{r}
cancer <- cancer[-158, ]
cancer <- cancer[-305,]
cancer <- cancer[-1637, ]
```

```{r}
cancer[cancer$idnum== 363,]
cancer[cancer$idnum== 192,]
cancer[cancer$idnum== 1933,]
```
Si convertono gli spazi vuoti in valori nulli, poichè essi sono dati mancanti
```{r}
cancer <- data.frame(lapply(cancer, function(x) ifelse(x == "", NA, x)), stringsAsFactors = FALSE)
```

Controllo dei valori nulli
```{r}
sum(is.na(cancer))
cancer <- na.omit(cancer)
```
Eliminazione dei valori mancanti
```{r}
cancer_clean <- cancer[order(cancer$incidenza),]
cancer_clean
```

Controllo ed esplorazione del dataset pulito
```{r}
summary(cancer_clean)
str(cancer_clean)
```
Ora andiamo ad esplorare il dataset attraverso dei grafici
1. Istogramma della distribuzione dei pazienti per stadio del tumore:

```{r}
ggplot(cancer_clean, aes(x=Stadio, fill=Stadio)) +
  geom_bar() +
  ylab("Numero di pazienti")
```

Questo grafico mostra la distribuzione dei pazienti per stadio del tumore. 

Grafico a barre della distribuzione dei pazienti per tipo di tumore:

```{r}
ggplot(cancer_clean, aes(x=tipotumore, fill=tipotumore)) +
  geom_bar()+
  ylab("Numero di pazienti")+
  xlab("Tipo di tumore")
```

Questo grafico mostra la distribuzione dei pazienti per tipo di tumore.

Boxplot della distribuzione delle date di diagnosi per stadio del tumore:
```{r}
ggplot(cancer_clean, aes(x=Stadio, y=incidenza)) +
  geom_boxplot()
```
 
Questo grafico mostra la distribuzione delle date di diagnosi per stadio del tumore attraverso i boxplot.


## Death

```{r}
summary(death)
str(death)
```

Correzione del formato delle colonne 'dead' e 'enddate'
```{r}
death$dead = as.factor(death$dead)
death$enddate = as.Date(death$enddate, tryFormats = "%Y-%m-%d" )
summary(death)
dim(death)
names(death)
str(death)
```

Controllo dei dati mancanti
```{r}
sum(is.na(death)) #non ci sono dati mancanti
```
Controllo dei duplicati
```{r}
sum(duplicated(death))
length(unique(death$idnum)) == length(death$idnum) #TRUE - no duplicati
```
Esploro il dataset corretto
```{r}
ggplot(death, aes(x = dead)) +
  geom_bar(fill = "blue") +
  labs(title = "Distribuzione dei decessi", 
       x = "Stato del paziente (0 = vivo, 1 = morto)", 
       y = "Numero di pazienti")
```
Questo grafico a barre mostra la distribuzione dei decessi con la variabile dicotomica "dead", dove 0 rappresenta i pazienti vivi e 1 rappresenta i pazienti deceduti


**German**

#Importo il dataset e procedo con un bel summary


```{r cars}
summary(GermanH)
str(GermanH)
```
Trasformo tutti i valori nulli in 0
```{r}
GermanH[is.na(GermanH)] <- 0
```
Si analizza quanti valori pari a 0 (ovvero nulli) presentano le singole colonne
```{r}
colSums(GermanH == 0)
```
Elimino i valori nulli
```{r}
GermanH_ok <- GermanH[apply(GermanH!=0,1,all),]
```

```{r}
colSums(GermanH_ok ==0)
```
Controllo dei duplicati
```{r}
nrow(GermanH_ok[duplicated(GermanH$idnum)])
```
Esplorazione del dataset pulito

```{r}
colors <- c("#FFA07A", "#ADD8E6")
```

```{r}
barplot(table(GermanH_ok$smoke), xlab="Fumatore", ylab="Numero dei pazienti", col= colors)
```
```{r}
barplot(table(GermanH_ok$sex), main="Frequenza di genere", xlab="Genere", ylab="Numero dei pazienti", col = colors)
```

```{r}
barplot(table(GermanH_ok$married), main="Freqeunza dello stato sociale", xlab="Coniugato", ylab="Numero dei pazienti", col = colors)
```

```{r}
barplot(table(GermanH_ok$kids), main="Freqeunza dei pazienti con figli ", xlab="Ha figli?", ylab="Numero dei pazeinti", col= colors)
```
```{r}
barplot(table(GermanH_ok$work), main="Freqeunza dei pazienti che lavorano", xlab="Lavora?", ylab="Numero dei pazienti", col = colors)
```


```{r}
ggplot(GermanH_ok, aes(age)) +
  geom_bar(fill = "#0073C2FF")+xlab('Età')+ylab("Numero dei pazienti")
```

#Sdo


```{r}
summary(sdo)
str(s)
```
Ordinamento del dataset
```{r}
sdo <- sdo[order(sdo$idnum), ]

```

Controllo dei duplicati

```{r}
nrow(sdo[duplicated(sdo$idnum),])
```
Formattazione delle colonne
```{r}
sdo$Prestazione <- as.factor(sdo$Prestazione)
sdo$ospedale <- as.factor(sdo$ospedale)
sdo$dataprestazione <- as.Date(sdo$dataprestazione, '%d/%m/%Y')
sdo$dimissione <- as.Date(sdo$dimissione, '%d/%m/%Y')
```


```{r}
summary(sdo)
```
Controllo dei valori nulli
```{r}
nrow(sdo[is.na(sdo$Prestazione),])
nrow(sdo[is.na(sdo$dataprestazione),])
sdo[is.na(sdo$dataprestazione),]
nrow(sdo[is.na(sdo$dimissione),])
sdo[is.na(sdo$dimissione),]
nrow(sdo[is.na(sdo$ospedale),])
```

Eliminazione dei valori nulli 

```{r}
sdo.no.na <- sdo[!is.na(sdo$dataprestazione) & !is.na(sdo$dimissione), ]
nrow(sdo.no.na[is.na(sdo.no.na$Prestazione),])
nrow(sdo.no.na[is.na(sdo.no.na$dataprestazione),])
nrow(sdo.no.na[is.na(sdo.no.na$dimissione),])
nrow(sdo.no.na[is.na(sdo.no.na$ospedale),])
```

Controllo della presenza di incongruenze tra date ed rimozione dei valori incongruenti.

```{r}
nrow(sdo.no.na[sdo.no.na$dataprestazione>sdo.no.na$dimissione, ])
sdo.no.na[sdo.no.na$dataprestazione>sdo.no.na$dimissione, ]
sdo.ok <- sdo.no.na[sdo.no.na$dataprestazione<sdo.no.na$dimissione, ]
```

Ottengo nuovamente le statistiche e creo alcuni plot.

```{r}
summary(sdo.ok)
```

```{r}
ggplot(sdo, aes(Prestazione)) +
  geom_bar(fill = "#0073C2FF") +
  theme_pubclean()+ylab("Numero dei pazienti")
```

```{r}
ggplot(sdo, aes(ospedale)) +
  geom_bar(fill = "#0073C2FF") +
  theme_pubclean()+ylab("Numero dei pazienti")+xlab("Ospedali")
```

I dataset sono stati tutti puliti e controllati, è stata svolta un analisi epslorativa iniziale ora si può passare alla  fase ddi linkage dei dataset per svolgere gli altri task.

